name: Build macOS Application

on:
  # Trigger on push to main branch
  push:
    branches: [ main, master ]
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:
  
  # Trigger on release
  release:
    types: [created]

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.6.1 openpyxl python-dateutil py2app
    
    - name: Create setup.py for py2app
      run: |
        cat > setup.py << 'EOF'
        from setuptools import setup

        APP = ['loan_calculator.py']
        DATA_FILES = []
        OPTIONS = {
            'argv_emulation': True,
            'packages': ['PyQt6', 'openpyxl', 'dateutil', 'calendar', 'json', 'os'],
            'includes': [
                'PyQt6.QtCore',
                'PyQt6.QtGui', 
                'PyQt6.QtWidgets',
                'openpyxl.styles',
                'openpyxl.utils',
                'dateutil.relativedelta'
            ],
            'plist': {
                'CFBundleName': 'Loan Calculator Pro',
                'CFBundleDisplayName': 'Loan Calculator Pro',
                'CFBundleGetInfoString': "Professional Loan Calculator with Amortization Schedule",
                'CFBundleIdentifier': "com.loancalculator.pro",
                'CFBundleVersion': "1.0.0",
                'CFBundleShortVersionString': "1.0.0",
                'NSHumanReadableCopyright': "Copyright Â© 2024 Yogesh Khurana. All Rights Reserved",
                'NSHighResolutionCapable': True,
            }
        }

        setup(
            app=APP,
            name='Loan Calculator Pro',
            data_files=DATA_FILES,
            options={'py2app': OPTIONS},
            setup_requires=['py2app'],
        )
        EOF
        
        cat setup.py
    
    - name: Build macOS application
      run: |
        echo "Building application..."
        python setup.py py2app
        
        echo "Verifying build..."
        ls -la dist/
    
    - name: Create DMG installer
      run: |
        echo "Creating DMG file..."
        
        # Create a temporary directory for DMG contents
        mkdir -p dmg_temp
        cp -r "dist/Loan Calculator Pro.app" dmg_temp/
        
        # Create a symbolic link to Applications folder
        ln -s /Applications dmg_temp/Applications
        
        # Create the DMG
        hdiutil create -volname "Loan Calculator Pro" \
          -srcfolder dmg_temp \
          -ov -format UDZO \
          -imagekey zlib-level=9 \
          LoanCalculatorPro.dmg
        
        echo "DMG created successfully!"
        ls -lh LoanCalculatorPro.dmg
    
    - name: Upload DMG as artifact
      uses: actions/upload-artifact@v3
      with:
        name: LoanCalculatorPro-macOS-DMG
        path: LoanCalculatorPro.dmg
        retention-days: 30
    
    - name: Upload App Bundle as artifact
      uses: actions/upload-artifact@v3
      with:
        name: LoanCalculatorPro-macOS-App
        path: dist/Loan Calculator Pro.app
        retention-days: 30
    
    - name: Get version info
      id: version
      run: |
        echo "version=1.0.0" >> $GITHUB_OUTPUT
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
    
    - name: Create Release (if triggered by tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: LoanCalculatorPro.dmg
        body: |

