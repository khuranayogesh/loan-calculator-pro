name: Build macOS Application

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller PyQt6 openpyxl python-dateutil
    
    - name: Verify installation
      run: |
        python -c "import PyQt6; print('PyQt6 version:', PyQt6.QtCore.qVersion())"
        python -c "import openpyxl; print('openpyxl installed')"
        python -c "import dateutil; print('dateutil installed')"
    
    - name: Build macOS application with PyInstaller
      run: |
        pyinstaller \
          --name "Loan Calculator Pro" \
          --windowed \
          --onedir \
          --icon=NONE \
          --osx-bundle-identifier com.loancalculator.pro \
          --hidden-import PyQt6.QtCore \
          --hidden-import PyQt6.QtGui \
          --hidden-import PyQt6.QtWidgets \
          --hidden-import openpyxl \
          --hidden-import openpyxl.styles \
          --hidden-import openpyxl.utils \
          --hidden-import openpyxl.cell \
          --hidden-import dateutil \
          --hidden-import dateutil.relativedelta \
          --collect-all PyQt6 \
          --collect-all openpyxl \
          loan_calculator.py
    
    - name: Verify build
      run: |
        echo "Listing dist directory:"
        ls -la dist/
        
        if [ -d "dist/Loan Calculator Pro.app" ]; then
          echo "✓ App bundle created successfully"
          echo "App contents:"
          ls -la "dist/Loan Calculator Pro.app/Contents/"
        else
          echo "✗ Error: App bundle not found"
          exit 1
        fi
    
    - name: Create DMG installer
      run: |
        echo "Creating DMG installer..."
        
        # Create temporary directory for DMG contents
        mkdir -p dmg_temp
        
        # Copy app to temp directory
        cp -r "dist/Loan Calculator Pro.app" dmg_temp/
        
        # Create symbolic link to Applications
        ln -s /Applications dmg_temp/Applications
        
        # Create the DMG
        hdiutil create \
          -volname "Loan Calculator Pro" \
          -srcfolder dmg_temp \
          -ov \
          -format UDZO \
          -imagekey zlib-level=9 \
          LoanCalculatorPro.dmg
        
        echo "✓ DMG created successfully"
        ls -lh LoanCalculatorPro.dmg
    
    - name: Upload DMG as artifact
      uses: actions/upload-artifact@v4
      with:
        name: LoanCalculatorPro-macOS-DMG
        path: LoanCalculatorPro.dmg
        retention-days: 90
    
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build/
        retention-days: 7
